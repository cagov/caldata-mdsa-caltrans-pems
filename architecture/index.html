
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../writing-documentation/">
      
      
        <link rel="next" href="../data-loading/">
      
      
      <link rel="icon" href="../images/odi-circle_logomark-blue.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Project Architecture - Traffic Operations Infrastructure</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#project-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Traffic Operations Infrastructure" class="md-header__button md-logo" aria-label="Traffic Operations Infrastructure" data-md-component="logo">
      
  <img src="../images/odi-square_logomark-blue.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Traffic Operations Infrastructure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Project Architecture
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Traffic Operations Infrastructure" class="md-nav__button md-logo" aria-label="Traffic Operations Infrastructure" data-md-component="logo">
      
  <img src="../images/odi-square_logomark-blue.svg" alt="logo">

    </a>
    Traffic Operations Infrastructure
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../writing-documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Writing Documentation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Project Architecture
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Project Architecture
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#snowflake-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Snowflake architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Snowflake architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#six-databases" class="md-nav__link">
    <span class="md-ellipsis">
      Six databases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#six-warehouse-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Six warehouse groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#six-roles" class="md-nav__link">
    <span class="md-ellipsis">
      Six roles
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reporting-and-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Reporting and analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-schema-names" class="md-nav__link">
    <span class="md-ellipsis">
      Custom schema names
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#developing-against-production-data" class="md-nav__link">
    <span class="md-ellipsis">
      Developing against production data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user-personae" class="md-nav__link">
    <span class="md-ellipsis">
      User personae
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-adding-a-new-data-source" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario: adding a new data source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-creating-a-new-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario: creating a new dashboard
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-loading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Loading
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../incremental/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Incremental Models
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/data-relay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Relay
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-warehouse-performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Warehouse Performance
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dbt_docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dbt Project
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Data Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Data Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/exploratory-data-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exploratory Data Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/data-relay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Relay
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/bottlenecks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bottlenecks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/imputation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Imputation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/data-transform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/performance-calcs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance Calculations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/detector-health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Detector Health Diagnostics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#snowflake-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Snowflake architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Snowflake architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#six-databases" class="md-nav__link">
    <span class="md-ellipsis">
      Six databases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#six-warehouse-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Six warehouse groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#six-roles" class="md-nav__link">
    <span class="md-ellipsis">
      Six roles
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reporting-and-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Reporting and analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-schema-names" class="md-nav__link">
    <span class="md-ellipsis">
      Custom schema names
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#developing-against-production-data" class="md-nav__link">
    <span class="md-ellipsis">
      Developing against production data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user-personae" class="md-nav__link">
    <span class="md-ellipsis">
      User personae
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-adding-a-new-data-source" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario: adding a new data source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-creating-a-new-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario: creating a new dashboard
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="project-architecture">Project architecture<a class="headerlink" href="#project-architecture" title="Permanent link">&para;</a></h1>
<p>This project is organized around centralizing data in a Snowflake cloud data warehouse.
Heterogeneous data sources are loaded into raw databases using custom Python scripts.
These datasets are then transformed into analysis-ready marts using <a href="https://www.getdbt.com/">dbt</a>.</p>
<p>We follow an adapted version of the project architecture described in
<a href="https://www.getdbt.com/blog/how-we-configure-snowflake/">this dbt blog post</a>
for our Snowflake dbt project.</p>
<p>It is described in some detail in ODI CalData's
<a href="https://cagov.github.io/data-infrastructure/snowflake/#architecture">Snowflake docs</a> as well.</p>
<pre class="mermaid"><code>flowchart TB
subgraph External Data Source
  G[(Geo Data)]
  CT[(\nCHP)]
  TR[(\nTransit)]
end
subgraph Caltrans VPN
    direction TB
    PQ[(\nDistrict TMC Servers)]
    C[(\nOther Data Source)]
  end
    PY&gt;Python Scripts]
    LS&gt;Landing Server]
    RS&gt;Relay Server]
subgraph AWS
  direction TB
  A[\AWS S3 Bucket/]
  subgraph Caltrans Snowflake
    subgraph prod environment
        direction TB
        RP[(RAW_PRD)]
        TP[(TRANSFORM_PRD)]
        AP[(ANALYTICS_PRD)]
    end
    subgraph dev environment
        direction TB
        RD[(RAW_DEV)]
        TD[(TRANSFORM_DEV)]
        AD[(ANALYTICS_DEV)]
    end
  end
end
P{{PowerBI}}
Pe{{PeMS}}

RS -- LOADER_PRD --&gt; A
A -- Data Pipelines --&gt; RP
LS --&gt; RS
CT --&gt; LS
TR --&gt; LS
RD -- TRANSFORMER_DEV --&gt; TD
TD -- TRANSFORMER_DEV --&gt; AD
RP -- TRANSFORMER_PRD --&gt; TP
TP -- TRANSFORMER_PRD --&gt; AP
RP -- TRANSFORMER_DEV --&gt; TD
AD -- REPORTER_DEV --&gt; P &amp; Pe
AP -- REPORTER_PRD --&gt; P &amp; Pe
AP --&gt; A
C --&gt; LS
PQ --&gt; LS
G --&gt; PY
PY -- LOADER_PRD --&gt; RP
PY -- LOADER_DEV --&gt; RD</code></pre>
<h2 id="snowflake-architecture">Snowflake architecture<a class="headerlink" href="#snowflake-architecture" title="Permanent link">&para;</a></h2>
<p>There are two <em>environments</em> set up for this project, development and production.
Resources in the development environment are suffixed with <code>DEV</code>,
and resources in the production environment are suffixed with <code>PRD</code>.</p>
<p>Most of the time, developers will be working in the development environment.
Once your feature branches are merged to <code>main</code>, they will be used in the production environment.</p>
<p>What follows is a brief description of the most important Snowflake resources
in the dev and production environments and how developers are likely to interact with them.</p>
<h3 id="six-databases">Six databases<a class="headerlink" href="#six-databases" title="Permanent link">&para;</a></h3>
<p>We have six primary databases in our project:</p>
<p>Where our <strong>Source</strong> data lives</p>
<ul>
<li><strong><code>RAW_DEV</code></strong>: Dev space for loading new source data.</li>
<li><strong><code>RAW_PRD</code></strong>: Landing database for production source data.</li>
</ul>
<p>Where data from our <strong>Staging and Intermediate</strong> models lives</p>
<ul>
<li><strong><code>TRANSFORM_DEV</code></strong>: Dev space for staging/intermediate models. This is where most of your dbt work is!</li>
<li><strong><code>TRANSFORM_PRD</code></strong>: Prod space for models. This is what builds in the nightly job.</li>
</ul>
<p>Where data from our <strong>Marts</strong> models lives</p>
<ul>
<li><strong><code>ANALYTICS_DEV</code></strong>: Dev space for mart models. Use this when developing a model for a new dashboard or report!</li>
<li><strong><code>ANALYTICS_PRD</code></strong>: Prod space for mart models. Point production dashboards and reports to this database.</li>
</ul>
<h3 id="six-warehouse-groups">Six warehouse groups<a class="headerlink" href="#six-warehouse-groups" title="Permanent link">&para;</a></h3>
<p>There are six warehouse groups for processing data in the databases,
corresponding to the primary purposes of the above databases.
They are available in a few different sizes, depending upon the needs of the the data processing job,
X-small (denoted by (<code>XS</code>), X-Large (denoted by (<code>XL</code>), and 4X-Large (denoted by <code>4XL</code>).
Most jobs on small data should use the relevant X-small warehouse.</p>
<ol>
<li><strong><code>LOADING_{size}_DEV</code></strong>: This warehouse is for loading data to <code>RAW_DEV</code>. It is used for testing new data loading scripts.</li>
<li><strong><code>TRANSFORMING_{size}_DEV</code></strong>: This warehouse is for transforming data in <code>TRANSFORM_DEV</code> and <code>ANALYTICS_DEV</code>. Most dbt developers will use this warehouse for daily work.</li>
<li><strong><code>REPORTING_{size}_DEV</code></strong>: This warehouse is for testing dashboards.</li>
<li><strong><code>LOADING_{size}_PRD</code></strong>: This warehouse is for loading data to <code>RAW_PRD</code>. It is used for production data loading scripts.</li>
<li><strong><code>TRANSFORMING_{size}_PRD</code></strong>: This warehouse is for transforming data in <code>TRANSFORM_PRD</code> and <code>ANALYTICS_PRD</code>. This warehouse is used for the nightly builds.</li>
<li><strong><code>REPORTING_{size}_PRD</code></strong>: This warehouse is for production dashboards.</li>
</ol>
<h3 id="six-roles">Six roles<a class="headerlink" href="#six-roles" title="Permanent link">&para;</a></h3>
<p>There are six primary functional roles:</p>
<ol>
<li><strong><code>LOADER_DEV</code></strong>: Dev role for loading data to the <code>RAW_DEV</code> database. This is assumed when developing new data loading scripts.</li>
<li>
<p><strong><code>LOADER_PRD</code></strong>: Prod role for loading data to the <code>RAW_PRD</code> database. This is assumed by data loading scripts.</p>
</li>
<li>
<p><strong><code>TRANSFORMER_DEV</code></strong>: Dev role for transforming data. This is you! Models built with this role get written to the <code>TRANSFORM_DEV</code> or <code>ANALYTICS_DEV</code> databases. CI robots also use this role to run checks and tests on PRs <em>before</em> they are merged to main.</p>
</li>
<li>
<p><strong><code>TRANSFORMER_PRD</code></strong>: Prod role for transforming data. This is assumed by the nightly build job and writes data to the <code>TRANSFORM_PRD</code> or <code>ANALYTICS_PRD</code> databases.</p>
</li>
<li>
<p><strong><code>REPORTER_DEV</code></strong>: Dev role for reading marts. Use this when developing new dashboards. This role can read models in the <code>ANALYTICS_DEV</code> database.</p>
</li>
<li><strong><code>REPORTER_PRD</code></strong>: Prod role for reading marts. This is for users and service accounts using production dashboards. This role can read models in the <code>ANALYTICS_PRD</code> database.</li>
</ol>
<h2 id="reporting-and-analysis">Reporting and analysis<a class="headerlink" href="#reporting-and-analysis" title="Permanent link">&para;</a></h2>
<p>The most prominent consumer of the data products from this project are PowerBI and ArcGis dashboards, the PeMS Server, public users (researchers, private sector, and other public agencies).</p>
<h2 id="custom-schema-names">Custom schema names<a class="headerlink" href="#custom-schema-names" title="Permanent link">&para;</a></h2>
<p>dbt's default method for generating <a href="https://docs.getdbt.com/docs/build/custom-schemas">custom schema names</a>
works well for a single-database setup:</p>
<ul>
<li>It allows development work to occur in a separate schema from production models.</li>
<li>It allows analytics engineers to develop side-by-side without stepping on each others toes.</li>
</ul>
<p>A downside of the default is that production models all get a prefix,
which may not be an ideal naming convention for end-users.</p>
<p>Because our architecture separates development and production databases,
and has strict permissions protecting the <code>RAW_PRD</code> database,
there is less danger of breaking production models.
So we use our own custom schema name modified from the
<a href="https://gitlab.com/gitlab-data/analytics/-/blob/master/transform/snowflake-dbt/macros/utils/override/generate_schema_name.sql">approach of the GitLab Data Team</a>.</p>
<p>In production, each schema is just the custom schema name without any prefix.
In non-production environments, dbt developers use their own custom schema based on their name: <code>dbt_username</code>.</p>
<h2 id="developing-against-production-data">Developing against production data<a class="headerlink" href="#developing-against-production-data" title="Permanent link">&para;</a></h2>
<p>Our Snowflake architecture allows for reasonably safe <code>SELECT</code>ing
from the production <code>RAW_PRD</code> database while developing models.
While this could be expensive for large tables,
it also allows for faster and more reliable model development.</p>
<p>To develop against raw production data, first you need someone with the <code>USERADMIN</code> role
to grant rights to the <code>TRANSFORMER_DEV</code> role
(this need only be done once, and can be revoked later):</p>
<div class="highlight"><pre><span></span><code><span class="n">USE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">USERADMIN</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">RAW_PRD_READ</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">TRANSFORMER_DEV</span><span class="p">;</span>
</code></pre></div>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<h3 id="user-personae">User personae<a class="headerlink" href="#user-personae" title="Permanent link">&para;</a></h3>
<p>To make the preceding more concrete, let's consider the six databases,
<code>RAW</code>, <code>TRANSFORM</code>, and <code>ANALYTICS</code>, for both <code>DEV</code> and <code>PRD</code>:</p>
<p><img alt="databases" src="../images/databases.png" /></p>
<p>If you are a developer, you are doing most of your work in <code>TRANSFORM_DEV</code>
and <code>ANALYTICS_DEV</code>, assuming the role <code>TRANSFORMER_DEV</code>.
<em>However</em>, you also have the ability to select the production data from <code>RAW_PRD</code> for your development.
So your data access looks like the following:</p>
<p><img alt="developer" src="../images/developer.png" /></p>
<p>Now let's consider the nigthly production build. This service account builds the production models
in <code>TRANSFORM_PRD</code> and <code>ANALYTICS_PRD</code> based on the raw data in <code>RAW_PRD</code>.
The development environment effectively doesn't exist to this account, and data access looks like the following:</p>
<p><img alt="nightly" src="../images/nightly.png" /></p>
<p>Finally, let's consider an external consumer of a mart from PowerBI.
This user has no access to any of the raw or intermediate models (which might contain sensitive data!).
To them, the whole rest of the architecture doesn't exist, and they can only see the marts in <code>ANALYTICS_PRD</code>:</p>
<p><img alt="consumer" src="../images/consumers.png" /></p>
<h3 id="scenario-adding-a-new-data-source">Scenario: adding a new data source<a class="headerlink" href="#scenario-adding-a-new-data-source" title="Permanent link">&para;</a></h3>
<ol>
<li>Write a new Python script (or configure an equivalent loading tool) for loading the data to Snowflake.</li>
<li>Assume the <code>LOADER_DEV</code> role and load the data into the <code>RAW_DEV</code> database.</li>
<li>Verify that the data was loaded and looks correct in Snowflake.</li>
<li>Schedule the Python script to run using the <code>LOADER_PRD</code> role and the <code>RAW_PRD</code> database. This data are now ready for dbt modeling.</li>
<li>Once the data is loaded to the <code>RAW_PRD</code> database, drop the data from the <code>RAW_DEV</code> database, itâ€™s not needed anymore.</li>
</ol>
<h3 id="scenario-creating-a-new-dashboard">Scenario: creating a new dashboard<a class="headerlink" href="#scenario-creating-a-new-dashboard" title="Permanent link">&para;</a></h3>
<ol>
<li>Create a branch and develop your new marts table (or modify an existing one) in <code>ANALYTICS_DEV</code> using your normal <code>TRANSFORMER_DEV</code> role.</li>
<li>Assume the <code>REPORTER_DEV</code> role with PowerBI and point it to your mart in <code>ANALYTICS_DEV</code>.</li>
<li>Once you are happy with your mart and dashboard, merge your branch to main.</li>
<li>Once the nightly job is done, your new mart will be built in <code>ANALYTICS_PRD</code>.</li>
<li>Assume the <code>REPORTER_PRD</code> role and point your PowerBI dashboard to the production mart.</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>
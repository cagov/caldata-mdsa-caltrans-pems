
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../data/data-relay/">
      
      
        <link rel="next" href="../dbt_docs/">
      
      
      <link rel="icon" href="../images/odi-circle_logomark-blue.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Data Warehouse Performance - Traffic Operations Infrastructure</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cloud-data-warehouses" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Traffic Operations Infrastructure" class="md-header__button md-logo" aria-label="Traffic Operations Infrastructure" data-md-component="logo">
      
  <img src="../images/odi-square_logomark-blue.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Traffic Operations Infrastructure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Data Warehouse Performance
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Traffic Operations Infrastructure" class="md-nav__button md-logo" aria-label="Traffic Operations Infrastructure" data-md-component="logo">
      
  <img src="../images/odi-square_logomark-blue.svg" alt="logo">

    </a>
    Traffic Operations Infrastructure
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../writing-documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Writing Documentation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-loading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Loading
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../incremental/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Incremental Models
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/data-relay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Relay
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Data Warehouse Performance
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Data Warehouse Performance
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-a-cloud-data-warehouse" class="md-nav__link">
    <span class="md-ellipsis">
      What is a cloud data warehouse?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is a cloud data warehouse?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage-based-pricing" class="md-nav__link">
    <span class="md-ellipsis">
      Usage-based pricing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-layout" class="md-nav__link">
    <span class="md-ellipsis">
      Data layout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constructing-queries-for-cloud-data-warehouses" class="md-nav__link">
    <span class="md-ellipsis">
      Constructing queries for cloud data warehouses
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primary-keys-and-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      Primary keys and constraints
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interactive-exercise" class="md-nav__link">
    <span class="md-ellipsis">
      Interactive Exercise
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interactive Exercise">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-query" class="md-nav__link">
    <span class="md-ellipsis">
      Initial query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#take-advantage-of-column-pruning" class="md-nav__link">
    <span class="md-ellipsis">
      Take advantage of column pruning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#take-advantage-of-partition-pruning" class="md-nav__link">
    <span class="md-ellipsis">
      Take advantage of partition pruning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#glossary" class="md-nav__link">
    <span class="md-ellipsis">
      Glossary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dbt_docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dbt Project
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Data Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Data Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/exploratory-data-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exploratory Data Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/data-relay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Relay
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/bottlenecks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bottlenecks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/imputation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Imputation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/data-transform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/performance-calcs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance Calculations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/detector-health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Detector Health Diagnostics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-a-cloud-data-warehouse" class="md-nav__link">
    <span class="md-ellipsis">
      What is a cloud data warehouse?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is a cloud data warehouse?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage-based-pricing" class="md-nav__link">
    <span class="md-ellipsis">
      Usage-based pricing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-layout" class="md-nav__link">
    <span class="md-ellipsis">
      Data layout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constructing-queries-for-cloud-data-warehouses" class="md-nav__link">
    <span class="md-ellipsis">
      Constructing queries for cloud data warehouses
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primary-keys-and-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      Primary keys and constraints
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interactive-exercise" class="md-nav__link">
    <span class="md-ellipsis">
      Interactive Exercise
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interactive Exercise">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-query" class="md-nav__link">
    <span class="md-ellipsis">
      Initial query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#take-advantage-of-column-pruning" class="md-nav__link">
    <span class="md-ellipsis">
      Take advantage of column pruning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#take-advantage-of-partition-pruning" class="md-nav__link">
    <span class="md-ellipsis">
      Take advantage of partition pruning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#glossary" class="md-nav__link">
    <span class="md-ellipsis">
      Glossary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="cloud-data-warehouses">Cloud Data Warehouses<a class="headerlink" href="#cloud-data-warehouses" title="Permanent link">&para;</a></h1>
<h2 id="what-is-a-cloud-data-warehouse">What is a cloud data warehouse?<a class="headerlink" href="#what-is-a-cloud-data-warehouse" title="Permanent link">&para;</a></h2>
<p>Cloud data warehouses (CDWs) are databases which are hosted in the cloud,
and are typically optimized around analytical queries like aggregations and window functions,
rather than the typical transactional queries that might support a traditional application.
This project uses <a href="https://www.snowflake.com/en/">Snowflake</a> as its data warehouse.</p>
<p>Cloud data warehouses typically have a few advantages over traditional transactional databases for analytical workflows, including:</p>
<ul>
<li>They are usually managed services, meaning you don't have to provision and maintain servers.</li>
<li>They can scale to truly massive data.</li>
</ul>
<p>By having a solid understanding of how cloud data warehouses work,
you can construct fast, efficient queries and avoid surprise costs.</p>
<h3 id="usage-based-pricing">Usage-based pricing<a class="headerlink" href="#usage-based-pricing" title="Permanent link">&para;</a></h3>
<p>With most on-premise transactional warehouses, costs scale with the number of server instances you buy and run.
These servers usually are always-on and power various applications with high availability.
In a traditional transactional warehouse both compute power and storage are associated with the same logical machine.</p>
<p>Cloud data warehouses typically have a different pricing model:
they decouple storage and compute and charge based on your query usage.
Snowflake charges based on the amount of <a href="https://www.snowflake.com/pricing/">compute resources needed to execute your queries</a>.
Google BigQuery charges based on the amount of <a href="https://cloud.google.com/bigquery/pricing">data your queries scan</a>.
There are also costs associated with data storage, but those are usually small compared to compute.
Though these two models are slightly different, they both lead to a similar take-home lesson:
by being careful with how data are laid out and accessed,
you can significantly reduce both execution time and cost for your cloud data warehouses.</p>
<h3 id="data-layout">Data layout<a class="headerlink" href="#data-layout" title="Permanent link">&para;</a></h3>
<p>Most cloud data warehouses use columnar storage for their data.
This means that data for each column of a table are stored sequentially in object storage
(this is in contrast to transactional databases which usually store each row, or record, sequentially in storage).
<a href="https://cloud.google.com/blog/topics/developers-practitioners/bigquery-admin-reference-guide-storage">This BigQuery blog post</a> goes into a bit more detail.</p>
<p><img alt="On the left is data laid out in a record-oriented way, where each row's values are contiguous in memory. On the right is data laid out in a columnar way, where each column's values are contiguous in memory." src="../images/columnar-storage.png" title="Columnar storage" /></p>
<p>There are a number of advantages to using columnar storage for analytical workloads:</p>
<ul>
<li>You can read in columns separately from each other.
    So if your query only needs to look at one column of a several-hundred column table,
    it can do that without incurring the cost of loading and processing all of the other columns.</li>
<li>Because the values in a column are located near each other in device storage,
    it is much faster to read them all at once for analytical queries like aggregations or window functions.
    In row-based storage, there is much more jumping around to different parts of memory.</li>
<li>Having values of the same data type stored sequentially allows for much more efficient
    serialization and compression of the data at rest.</li>
</ul>
<p>In addition to columnar storage,
cloud data warehouses also usually divide tables row-wise into chunks called partitions.
Different warehouses choose different sizing strategies for partitions,
but they are typically from a few to a few hundred megabytes.
Having separate logical partitions in a table allows the compute resources to process the partitions independently of each other in parallel.
This massively parallel processing capability is a large part of what makes cloud data warehouses scalable.
When designing your tables, you can often set partitioning strategies or clustering keys for the table.
This tells the cloud data warehouse to store rows with similar values for those keys within the same partitions.
A well-partitioned table can enable queries to only read from the partitions that it needs, and ignore the rest.</p>
<h3 id="constructing-queries-for-cloud-data-warehouses">Constructing queries for cloud data warehouses<a class="headerlink" href="#constructing-queries-for-cloud-data-warehouses" title="Permanent link">&para;</a></h3>
<p>With the above understanding of how cloud data warehouses store and process data,
we can write down a set of recommendations for how to construct efficient queries for large tables stored within them:</p>
<ul>
<li><em>Only <code>SELECT</code> the columns you need.</em>
    Columnar storage allows you to ignore the columns you don't need,
    and avoid the cost of reading it in. <code>SELECT *</code> can get expensive!</li>
<li><em>If the table has a natural ordering, consider setting a clustering key.</em>
    For example, if the data in the table consists of events with an associated timestamp,
    you might want to cluster according to that timestamp.
    Then events with similar times would be stored near each other in the same or adjacent partitions,
    and queries selecting for a particular date range would have to scan fewer partitions.</li>
<li><em>If the table has a clustering key already set, try to filter based on that in your queries.</em>
    This can greatly reduce the amount of data you need to scan. The queries based on these filters
    should be as simple as you can manage, complex predicates on clustered columns can make it
    difficult for query optimizers to prune partitions.
    You can tell if Snowflake has a clustering key set by inspecting the table definition for a <code>cluster by</code> clause.</li>
<li><em>Filter early in complex queries, rather than at the end.</em>
   If you have complex, multi-stage queries, filtering down to the subset of interest at the outset
   can avoid the need to process unnecessary data and then throw it away later in the query.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For people coming from transactional databases,
the considerations about clustering may seem reminiscent of indexes.
Cloud data warehouses usually don't have traditional indexes,
but clustering keys fill approximately the same role,
tailored to the distributed compute model.</p>
</div>
<h3 id="primary-keys-and-constraints">Primary keys and constraints<a class="headerlink" href="#primary-keys-and-constraints" title="Permanent link">&para;</a></h3>
<p>A central feature of cloud data warehouses is that storage is separate from compute,
and data can be processed in parallel by distributed compute resources that are only running
(and thus only costing you money) while they are needed.
The less communication that needs to happen between these distributed compute resources,
the faster they can work.
For this reason, most cloud data warehouses do not support primary keys,
foreign keys, or other constraints.</p>
<p>For example: if we have a foreign key constraint set on a table and insert a new record,
we would have to scan every single row of the parent table to see if the referenced row exists and is unique.
If the table is large and partitioned, this could mean spinning up a large amount of compute resources,
just to insert a single row.
So rather than supporting constraints with horrible performance characteristics,
cloud data warehouses just don't do it.
This can be surprising to some people, since they often still include the syntax for constraints for SQL standard compatibility
(see the Snowflake docs on <a href="https://docs.snowflake.com/en/sql-reference/constraints-overview">constraints</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One exception to the above is <code>NOT NULL</code> constraints,
which can be done cheaply since they don't require information from other tables or partitions to be enforced.</p>
</div>
<h2 id="interactive-exercise">Interactive Exercise<a class="headerlink" href="#interactive-exercise" title="Permanent link">&para;</a></h2>
<p>This exercise is intended to be done live with collaborators.
It should read fine, but will be more impactful if we set up a lab setting!</p>
<p>We'll be querying PeMS vehicle detector station data stored in Snowflake.
The dataset in question consists of (at the time of this writing)
20+ years of detector data at thirty second resolution.
It has a quarter of a trillion events and takes over 2 terabytes of storage.</p>
<p>Because it is event data with a timestamp, we have set a clustering key for the event date on the column <code>SAMPLE_DATE</code>,
so that all events with the same date are in the same (or adjacent) partitions.</p>
<p>All queries for this exercise were run on an XL Snowflake warehouse.</p>
<h4 id="initial-query">Initial query<a class="headerlink" href="#initial-query" title="Permanent link">&para;</a></h4>
<p>Suppose we want to know how many vehicles are counted in the first lane of each station for each calendar date in 2023.
An initial query might look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">ID</span><span class="p">,</span>
<span class="w">    </span><span class="n">SAMPLE_DATE</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_1</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_2</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_3</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_4</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_4</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_5</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_5</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_6</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_6</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_7</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_7</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_8</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW_8</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">RAW_PRD</span><span class="p">.</span><span class="n">CLEARINGHOUSE</span><span class="p">.</span><span class="n">STATION_RAW</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">SAMPLE_DATE</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">date_from_parts</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">AND</span><span class="w"> </span><span class="n">SAMPLE_DATE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">date_from_parts</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">SAMPLE_DATE</span>
</code></pre></div>
<p>This query took about three minutes to run. Not too bad!
But when we look at some statistics from the query profile, we start to see some problems:</p>
<p><img alt="Initial query profile" src="../images/pruning-exercise-initial.png" title="Initial query profile" /></p>
<p>Yikes! We can see from the "Bytes scanned" that this query scanned almost a terabyte of data,
or about half of the overall dataset.
Ideally, we should not scan the entire dataset to get some relatively simple statistics for a single year.
We can also see that from the "Profile Overview", remote disk I/O takes about 86% of the execution time.
This represents reads/writes to and from Snowflake's abstract cloud object storage.
Since this is the bulk of the execution time, anything we can do to cut down on disk I/O will be worthwhile.</p>
<p>Based on an XL warehouse's burn rate of about $1 per minute, this query costs about $3.
If we were running this many times a day, it could easily cost thousands of dollars per year.</p>
<h4 id="take-advantage-of-column-pruning">Take advantage of column pruning<a class="headerlink" href="#take-advantage-of-column-pruning" title="Permanent link">&para;</a></h4>
<p>Let's see what we can do to cut down on the amount of data that is read by our query.
Note that we are doing an aggregation on all eight lanes of traffic in the dataset,
but our initial question only asked about the first lane of traffic.
We are computing (and thus reading) more data than we actually need for the problem!
Because data are stored in a columnar layout, it's easy to reduce the data scanned
by just not selecting the columns we don't need.</p>
<p>Let's just select the flow for the first lane:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">ID</span><span class="p">,</span>
<span class="w">    </span><span class="n">SAMPLE_DATE</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">RAW_PRD</span><span class="p">.</span><span class="n">CLEARINGHOUSE</span><span class="p">.</span><span class="n">STATION_RAW</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">SAMPLE_DATE</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">date_from_parts</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">AND</span><span class="w"> </span><span class="n">SAMPLE_DATE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">date_from_parts</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">SAMPLE_DATE</span>
</code></pre></div>
<p>This ran in under two minutes, and by inspecting the query profile, it's clear why:
this query scanned a little over half the amount of data as the first one.
By selecting the only the columns we wanted, we avoided loading a lot of unnecessary data!</p>
<p><img alt="column-pruning" src="../images/pruning-exercise-column.png" title="Column pruning" /></p>
<p>Manually selecting all table columns or using <code>SELECT *</code> is often a bad idea in any database,
but it can have particularly bad performance consequences for columnar data warehouses.</p>
<h4 id="take-advantage-of-partition-pruning">Take advantage of partition pruning<a class="headerlink" href="#take-advantage-of-partition-pruning" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TL;DR: if a large table has a clustering key set, try to use it in filters,
aggregations, and windowing operations. Try to keep predicates using that key
as simple as possible to help out the query optimizer.</p>
</div>
<p>There is another problem with the performance of the above queries.
You can see that there are about two hundred thousand partitions in the entire dataset ("Partitions total").
And the number of partitions that the queries scanned ("Partitions scanned") was the same!
That is to say, we needed to read through every single partition,
even though we were only interested in the partitions corresponding to 2023.</p>
<p>Because we set a clustering key for the <code>SAMPLE_DATE</code>, we should be able to efficiently select
records for specific date ranges.
However, query optimizers are not always as good at reasoning about partitions as we would like them to be.
In this case, Snowflake is unable to reason about the result of the <code>date_from_parts()</code> function well enough
to know what its result will be (even though it will result in a constant date!).</p>
<p>Since Snowflake cannot figure out the result of the <code>date_from_parts()</code> call,
it gives up and scans every partition to figure out if its date is satisfied by the filtering predicates.
Inefficient queries scan every single partition.
If, however, we write a hard-coded date string, Snowflake's query optimizer <em>is</em> able to figure out
which partitions it needs to read. So the following query, which is logically equivalent,
has <em>much</em> better performance characteristics</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">ID</span><span class="p">,</span>
<span class="w">    </span><span class="n">SAMPLE_DATE</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">FLOW_1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">FLOW</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">RAW_PRD</span><span class="p">.</span><span class="n">CLEARINGHOUSE</span><span class="p">.</span><span class="n">STATION_RAW</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">SAMPLE_DATE</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;2023-01-01&#39;</span>
<span class="k">AND</span><span class="w"> </span><span class="n">SAMPLE_DATE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s1">&#39;2024-01-01&#39;</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">SAMPLE_DATE</span>
</code></pre></div>
<p>This runs in about seventeen seconds, and only scans a small fraction of the partitions in the dataset:</p>
<p><img alt="Partition pruning" src="../images/pruning-exercise-partition.png" title="Partition pruning" /></p>
<p>You'll also note that the total processing time is much more weighted towards actual data processing
rather than I/O.
This is a good thing: we want our compute processes to be working hard for us,
rather than waiting idly for data to traverse the network while they cost money.</p>
<p>The moral here is: partition pruning can drastically reduce the amount of data you need to process,
but you sometimes need to be careful about query construction to have it behave properly.
Pay attention to the results of the query profile if your queries are not having the performance you expect!</p>
<h4 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h4>
<p>By using our knowledge about how cloud data warehouses work and how their data are laid out,
we were able to take a query that took several minutes and cost a few dollars
to one that took a fraction of the time and cost a few cents.</p>
<p>It's a good idea to keep an eye on the query profiler to make sure your queries are performing as expected
(especially for ones that are run frequently, or touch a lot of data).</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.snowflake.com/en/user-guide/tables-clustering-micropartitions">Snowflake documentation on clustering and micropartitions</a></li>
<li><a href="https://docs.snowflake.com/user-guide/ui-query-profile">Snowflake documentation on query performance profiling</a></li>
<li><a href="https://cloud.google.com/blog/topics/developers-practitioners/bigquery-explained-storage-overview">Blog post on BigQuery's strategy for data layout and storage</a></li>
<li><a href="https://cloud.google.com/bigquery/docs/partitioned-tables">BigQuery partitioning guide</a></li>
<li><a href="https://cloud.google.com/bigquery/docs/best-practices-performance-overview">BigQuery optimization guide (most tips apply more generally to CDWs)</a></li>
</ul>
<h2 id="glossary">Glossary<a class="headerlink" href="#glossary" title="Permanent link">&para;</a></h2>
<p><strong>Clustering key</strong>: A clustering key is a special column in a table which instructs the database to order
    the records in the table according to that column. In cloud data warehouses which partition
    their tables into chunks, records with the same value for a clustering key will be
    stored in the same (or nearby) partitions.
<strong>Foreign key</strong>: A foreign key is a special column in a table which refers to the <em>primary key</em> of another
    table. Using foreign keys allows related tables to be linked, and they are often used in join operations.
    Traditional transactional databases often have strict guarantees (or constraints) around foreign keys.
    Cloud data warehouses typically do not respect those constraints.
<strong>Partition</strong>: A partition is a chunk of rows in a database table that are stored contiguously in memory.
    Cloud data warehouses commonly organize their tables into partitions of tens to hundreds of megabytes.
<strong>Partition pruning</strong>: The process by which a query optimizer decides whether it needs to read a given
    partition for a query.
<strong>Primary key</strong>: A primary key is a special column in a table which serves as an identifier for a record.
    In traditional transactional databases, they are usually required to be non-null and unique.
    Cloud data warehouses typically do not respect those constraints.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>
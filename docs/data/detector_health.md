# Detector Health Diagnostics

Vehicle detectors are the main source of data in PeMS and provide the best source of real-time traffic data
available to Caltrans. Data from the detectors is relayed from the field to District TMC's which ultimatley
makes it's way to PeMS. The detector data is combined with equipment data 
(i.e. detector id, district, county, route, postmile, description, etc.) in order to calculate performance
measures and aggregate them spatially and temporaly. Since the detector data serves as the source for most
of the performance calculations, the resulting performance measures are only as accurate as the underlying data. 

The Detector Health Diagnostic checks performed in the system serve multiple purposes:
    1. Checks to ensure detectors and other equipment are functioning properly
    2. Serves as a data quality check against data that is being reported by detectors
    3. Assist Caltrans staff in troubleshooting and maintaining detectors/stations/controllers
    4. Used as a data quality measure for imputation, bottleneck and other calculations 

For every analysis performed in the system, confirming the data quality is essential.

Caltrans has installed detectors to cover most urban freeways on the State Highway System. The data collected,
however, can contain missing values (also referred to as "holes") or “bad” (incorrect) values that require
data quality analysis to ensure the highest level of data quality is being used to produce reliable results.
The system contains various data quality checks to detect when data is "bad" to ensure the "bad" data is not used
to compute performance measures. When "bad" or missing data is encountered, the system imputes values to fill these
data "holes". The resulting database of complete and reliable data ensures that analyses produce meaningful results.
Although no estimation approach is perfect, the system relies on extensive analysis of all of the detectors in the
state to help approximate what the true values would be had the faulty detectors been working properly and sending
good data. The ability of PeMS to adjust for missing data is a real advantage in using PeMS for performance measurement.

Detectors can go "bad" or malfunction for many reasons. This is typically an intermittent or recurrent problem that can
require different approaches to properly diagnose and fix. The system devotes a substantial amount of its computing resources
to identifying bad detectors and calculating health diagnostics to help users evaluate data quality and to help those
responsible for detector maintenance.

There are many potential points of failure in this process, which can include the physical devices themselves (i.e. hardware,
equipment, device, communications links, etc.) or can also involve non-physical, “human error,” such as making errors in the
configuration of the device such as associating the wrong county, route and postmile with a station, or assigning the wrong
identification number to a station. These human errors can be difficult to diagnose.

The PeMS procedure for identifying bad detectors is based on observed measurements of volume and occupancy. The system computes
summary statistics from the measurements recorded every day from 5am to 10 pm. The system performs a number of simple calculations
on individual data samples to make sure that they meet sertain threshold criteria based on the detector type. The concept is that
when detectors are "bad" (i.e. fail one of the diagnostic tests), they stay broken until fixed or corrected and determined to be
good. The goal is to find bad detectors rather than bad data.


Diagnostic tests are applied to all types of detectors in the system, including on- and off-ramp detectors. PeMS applies tests 
tailored for each detector type. Since ramp detectors usually report only flow and most mainline detectors report flow and occupancy,
PeMS uses a subset of the mainline detector tests for ramp detector testings. The table below lists the tests that are applied to
the data from each detector at the end of the day. PeMS uses the tests in the order listed. PeMS applies most of these tests to the
30-second data but some are applied to the 5-minute data. For all of these tests, PeMS determines whether there are too many samples
that match a certain criterion.

The following tests have been tested, adjusted, and re-adjusted to yield effective results. The algorithms based on the
tests have their historical roots in a paper by Chen, Kwon, Skabardonis and Varaiya (members of the PeMS original 
development team). This paper, "Detecting errors and imputing missing data for single loop surveillance systems," is 
available on the Internet at http://pems.dot.ca.gov/Papers/loops_asv2.pdf. The algorithms that PeMS use have been
modified from the original version described in the paper as a result of Caltrans’ experience operating PeMS for more
than a decade.

| Test Number                                                                                                                                                                                                              | Detector Types                                                                                              | Condition                      | Description                                                                                                                                                                                                                                                                                                              | Diagnostic Test                                                                                                                                                                  | Data Used | Diagnostic         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------- | ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ------------------ |
| 1                                                                                                                                                                                                                        | ML, HOV, Ramp                                                                                               | Never receive any data samples | PeMS break down this condition into three bins based on the communication infrastructure. The first bin indicates that none of the detectors in the district as the selected detector are reporting data. When a district feed is down all of the data calculated in the system for that day in the district is imputed. | Number of samples received is equal to zero for all detectors in the district.                                                                                                   | 30-sec    | District Feed Down |
| The second bin indicates that none of the detectors attached to the same controller as the selected detector are reporting data. This probably indicates no power at this location or the communication link is broken.  | Number of samples received is equal to zero for all detectors attached to the controller.                   | 30-sec                         | Controller Down                                                                                                                                                                                                                                                                                                          |
| The third bin indicates that the individual detector is not reporting any data, but other detectors on the same controller are sending samples. This most likely indicates a software configuration error or bad wiring. | Number of samples received is equal to zero, but other detectors on the same controller are reporting data. | 30-sec                         | No Data                                                                                                                                                                                                                                                                                                                  |
| 2                                                                                                                                                                                                                        | ML, HOV,<br>Ramp                                                                                            | Too few data samples           | PeMS received some samples but not enough to perform diagnostic tests. Other detectors reported more samples (so the data feed did not die).                                                                                                                                                                             | \# of samples < 60% of the max collected samples during the test period.                                                                                                         | 30-sec    | Insufficient Data  |
| 3                                                                                                                                                                                                                        | ML, HOV, Ramp                                                                                               | Zero occupancy or flow         | There are too many samples with an occupancy (ML & HOV only) or flow (Ramp only) of zero. PeMS suspects that the detector card (in the case of standard loop detectors) is off.                                                                                                                                          | ML and HOV: # zero occ samples > % of the max collected samples during the test period.<br>Ramp: # zero flow samples > % of the max collected samples during the test<br>period. | 30-sec    | Card Off           |
| 4                                                                                                                                                                                                                        | ML, HOV, Ramp                                                                                               | High values                    | There are too many samples with either occupancy above 0% (ML and HOV only) or flow above veh/30-sec (Ramps only). The detector is probably stuck on.                                                                                                                                                                    | ML and HOV: # high occ samples > % of the max collected samples during the test period.<br>Ramp: # high flow samples > % of the max collected samples during the test<br>period. | 30-sec    | High Value         |
| 5                                                                                                                                                                                                                        | ML, HOV                                                                                                     | Flow-Occupancy mismatch        | There are too many samples where the flow is zero and the occupancy is non- zero. This could be caused by the detector hanging on.                                                                                                                                                                                       | \# of flow-occupancy mismatch samples > % of the max collected samples during the test period.                                                                                   | 30-sec    | Intermittent       |
| 6                                                                                                                                                                                                                        | ML, HOV                                                                                                     | Occupancy is constant          | The detector is stuck at some value for some reason. PeMS knows that occupancy should have some variation over the day. PeMS count the number of times that the occupancy value is non-zero and repeated from the last sample (is exactly the same as the last sample).                                                  | \# repeated occupancy values > 5-min samples.                                                                                                                                    | 5-min     | Constant Occupancy |
The basic idea of the diagnostic scheme is to identify bad detectors based on the observed measurements of volume and occupancy over an entire day. We do this by computing summary statistics from the flow and occupancy measurements every day.

It is important to note that we are attempting to identify bad detectors, not bad data samples. PeMS performs a number of simple filters on individual data samples just to make sure that they make sense as a measurement (e.g., that there aren't any values less than zero, that the values can fit into our database fields, etc). But it doesn't perform real-time checks to verify that each individual data sample conformx to traffic flow theory (e.g., that the combination of measured flow and occupancy fit into some space on the Fundamental Diagram). This approach is based on the observation that when detectors are broken they stay broken.

We perform the diagnostic tests on all detectors in the PeMS system including on and off ramps. The types of tests that we apply are different for each type of detector. For example, most mainline detectors report flow and occupancy whereas ramp detectors usually only report flow. Hence for ramps we can only do a subset of the tests that we perform for mainline detectors.

Below we list out the tests that we apply to the data from each detector at the end of the day. We apply them in the order listed. Most of these tests are applied to the 30-second data but some are applied to the 5-minute data. For all of these tests we test whether there are too many samples that match a certain criterion. We always define too many relative to the maximum number of samples collected by any detector during the day. This way if the data feed cuts off in the middle of the day then we'll still be able to apply the tests consistently. We indicate whether the test is applied to mainline, ML, or ramp detectors, RM, (by ramp detectors we mean all non-mainline, non-HOV detectors).

The steps that are involved in actually implementing the complete diagnostic algorithm are as follows:

We compute the statistics needed for the above tests over the time period from 5am until 10pm (we don't want to capture the time period when there are very little vehicles on the freeway anyways) every day.
For each of the above tests, we check the statistics against the predefined thresholds. If any of the tests for a detector fails, then the detector is declared bad and we stop testing.
We record that the detector is declared as bad in the database. Users can subsequently view tables of bad loops.
Once a mainline or HOV detector is identified as bad, we impute data in order to fill in for the bad detector the next day. Note that we do not impute for any ramp detectors.
It is important to note that we do not identify individual data samples as bad or good. We make this determination on a detector-by-detector basis each day.
When the data feed fails in the middle of the day, or it has failed for a number of days in a row, and we can't collect enough data to run the diagnostic algorithms, then we copy the detector diagnostics from the previous day. For the detectors that used to be good we simply mark them as good for this day as well. For the detectors that used to be bad we keep them marked as bad but we change their status to Feed Unstable. Hence when the feed returns, we are assuming that the previously good detectors are still good and that the previously bad detectors are still bad - the feed failure had nothing to do with the health of each individual detector. We change the status to Feed Unstable because we can't collect enough samples to verify the different types of error conditions that were previously assigned to the detectors. So we don't want to incorrectly declare a reason for failure.
Decomposing Communications Down Errors
The PeMS diagnostic approach has always been to assign failure modes to the individual loop detectors. When PeMS receives data samples it can test the samples for reasonableness and deduce a number of different types of errors. But when PeMS receives no data samples it's not possible to tell if the detector itself is bad. For example, it could be that we aren't receiving any data samples from any detector simply because the FEP is down. For situations like this we use to mark the detector as bad with a reason of communication down. But in reality this failure category has always been a catch-all category that simply represents that we didn't receive any data samples.

It turns out that we can do better than this if we know the physical data collection infrastructure. By physical data collection infrastructure we mean knowing which detectors are connected to which controllers, and which controllers are connected over which lines to the FEP. For example, if we know that all of the detectors that are connected to a single controller are not sending any data samples, in other words, we're not receiving any data from the controller, then it's likely that the controller itself is broken. For example there could be no power at the controller, or it could have been damaged in an accident (or removed during construction). In a similar manner, if we're not receiving any data from any of the controllers on a line then it's likely that the line itself is bad rather than every controller is bad.

In response to this we've taken out the diagnostic state according to communications down and we've substituted in the states of controller down, line down and no data. If we don't receive any samples from a line then the line is considered to be down and all of the detectors on the line are marked as line down. If we receive samples from some controllers on a line but not others then the controllers are considered to be down and the loops belonging to those controllers are marked as controller down. And if we receive samples from some detectors but not others for a single controller then the non-reporting detectors are considered to be down but not the controller and are marked as no data. It should be pointed out that we're assuming that the line and/or the controller is the problem if we don't receive data samples from the detectors underneath them. But it could be that all of the individual loops are broken (we consider this to be unlikely, though).

The locations where this scheme doesn't work are the districts where we don't have the physical topology of the data collection infrastructure, or the data collection infrastructure is just a star. District 4 doesn't provide us with their data collection infrastructure and District 10 has only wireless modems that are sending data back to a centralized point. In the D10 case the rollup algorithm still works but the results are blank for the line level.